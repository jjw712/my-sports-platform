generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Post {
  id           Int            @id @default(autoincrement())
  title        String
  content      String
  createdAt    DateTime       @default(now())
  dislikeCount Int            @default(0)
  likeCount    Int            @default(0)
  authorKey    String         @default("guest_bootstrap")
  authorRole   Role           @default(GUEST)
  reactions    PostReaction[]
}

model PostReaction {
  id        Int          @id @default(autoincrement())
  postId    Int
  userId    String
  type      ReactionType
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Venue {
  id           String   @id @default(cuid())
  name         String
  sido         String
  sigungu      String?
  address      String?
  lat          Float?
  lng          Float?
  sports       String[]
  facilityType String?
  source       String
  sourceId     String?
  uniqueKey    String   @unique
  fetchedAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  matchPosts MatchPost[]
  matches   Match[]

  @@index([sido, sigungu])
  @@index([lat, lng])
  @@unique([source, sourceId])
}

model Team {
  id           Int              @id @default(autoincrement())
  name         String           @unique
  sport        TeamSport        @default(SOCCER)
  region       String?
  logoUrl      String?
  description  String?
  skillRating  Int              @default(0)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  hostMatchPosts MatchPost[]    @relation("HostTeamMatchPosts")
  challenges   MatchChallenge[] @relation("ChallengerTeamChallenges")
  hostedMatches Match[]         @relation("HostTeamMatches")
  awayMatches  Match[]          @relation("AwayTeamMatches")

  @@index([region])
}

model MatchPost {
  id          Int              @id @default(autoincrement())
  hostTeamId  Int
  venueId     String
  title       String
  description String
  status      MatchPostStatus  @default(OPEN)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  hostTeam    Team             @relation("HostTeamMatchPosts", fields: [hostTeamId], references: [id])
  venue       Venue            @relation(fields: [venueId], references: [id])
  slots       TimeSlot[]
  challenges  MatchChallenge[]
  matches     Match[]
}

model TimeSlot {
  id          Int              @id @default(autoincrement())
  matchPostId Int
  startAt     DateTime
  endAt       DateTime
  status      TimeSlotStatus   @default(OPEN)
  createdAt   DateTime         @default(now())
  matchPost   MatchPost        @relation(fields: [matchPostId], references: [id])
  challenges  MatchChallenge[]

  @@index([matchPostId, startAt])
}

model MatchChallenge {
  id               Int             @id @default(autoincrement())
  matchPostId      Int
  slotId           Int
  challengerTeamId Int
  message          String
  status           ChallengeStatus @default(PENDING)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  matchPost        MatchPost       @relation(fields: [matchPostId], references: [id])
  slot             TimeSlot        @relation(fields: [slotId], references: [id])
  challengerTeam   Team            @relation("ChallengerTeamChallenges", fields: [challengerTeamId], references: [id])

  @@unique([matchPostId, challengerTeamId])
  @@index([slotId])
}

model Match {
  id         Int         @id @default(autoincrement())
  hostTeamId Int
  awayTeamId Int
  venueId    String
  startAt    DateTime
  endAt      DateTime
  status     MatchStatus @default(SCHEDULED)
  matchPostId Int?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  hostTeam   Team        @relation("HostTeamMatches", fields: [hostTeamId], references: [id])
  awayTeam   Team        @relation("AwayTeamMatches", fields: [awayTeamId], references: [id])
  venue      Venue       @relation(fields: [venueId], references: [id])
  matchPost  MatchPost?  @relation(fields: [matchPostId], references: [id])

  @@index([hostTeamId, startAt])
  @@index([awayTeamId, startAt])
}

enum MatchPostStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum TimeSlotStatus {
  OPEN
  LOCKED
}

enum ChallengeStatus {
  PENDING
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum MatchStatus {
  SCHEDULED
  CANCELLED
  COMPLETED
}

enum TeamSport {
  SOCCER
  BASKETBALL
  BASEBALL
}

enum ReactionType {
  LIKE
  DISLIKE
}

enum Role {
  GUEST
  USER
  ADMIN
}
